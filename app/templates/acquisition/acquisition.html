{% extends "base.html" %}

{% block body %}
<main class="w-full">
  <div class="mx-auto w-full max-w-5xl px-4 py-10">
    <!-- Header -->
    <div class="text-center mb-10">
      <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight text-slate-900">
        Módulo de Aquisição
      </h1>
      <p class="mt-2 text-slate-600">
        Gerador de mensagens de prospecção para WhatsApp.
      </p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
      <!-- Form Card -->
      <section class="lg:col-span-5">
        <div class="bg-white/80 backdrop-blur rounded-2xl shadow-lg border border-slate-200 p-6">
          <h2 class="text-lg font-bold text-slate-900">Preencha os dados</h2>
          <p class="text-sm text-slate-600 mt-1">
            Quanto mais específico, melhor a qualidade das mensagens.
          </p>

          <form class="mt-6 space-y-4" method="post" action="/acquisition/generate">
            <div>
              <label class="block text-sm font-semibold text-slate-700">Nicho</label>
              <input
                type="text"
                name="nicho"
                value="{{ (form.nicho if form is defined and form) else '' }}"
                placeholder="Ex: Energia Solar"
                class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-4 py-3 text-slate-900 placeholder-slate-400 shadow-sm focus:outline-none focus:ring-4 focus:ring-orange-200 focus:border-orange-400"
              />
            </div>

            <div>
              <label class="block text-sm font-semibold text-slate-700">Cidade</label>
              <input
                type="text"
                name="cidade"
                value="{{ (form.cidade if form is defined and form) else '' }}"
                placeholder="Ex: São Paulo"
                class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-4 py-3 text-slate-900 placeholder-slate-400 shadow-sm focus:outline-none focus:ring-4 focus:ring-orange-200 focus:border-orange-400"
              />
            </div>

            <div>
              <label class="block text-sm font-semibold text-slate-700">Tipo de Serviço</label>
              <input
                type="text"
                name="servico"
                value="{{ (form.servico if form is defined and form) else '' }}"
                placeholder="Ex: Instalação residencial"
                class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-4 py-3 text-slate-900 placeholder-slate-400 shadow-sm focus:outline-none focus:ring-4 focus:ring-orange-200 focus:border-orange-400"
              />
            </div>

            <button
              type="submit"
              class="w-full rounded-xl bg-brand-600 px-4 py-3 font-bold text-white shadow-lg shadow-orange-200 hover:bg-brand-700 active:scale-[0.99] transition"
            >
              Gerar mensagens
            </button>

            <div class="text-xs text-slate-500 leading-relaxed">
              Dica: você pode gerar, copiar e enviar para vários clientes rápido.
            </div>
          </form>
        </div>

        <!-- Mini help card -->
        <div class="mt-6 bg-white/70 backdrop-blur rounded-2xl border border-slate-200 p-5">
          <div class="flex items-start gap-3">
            <div class="mt-0.5 h-9 w-9 rounded-xl bg-orange-100 flex items-center justify-center">
              <span class="text-orange-700 font-black">!</span>
            </div>
            <div>
              <p class="font-semibold text-slate-900">Como usar</p>
              <p class="text-sm text-slate-600 mt-1">
                1) Preencha os campos • 2) Clique em <b>Gerar mensagens</b> • 3) Use <b>Enviar no WhatsApp</b> ou <b>Copiar</b>.
              </p>
            </div>
          </div>
        </div>
      </section>

      <!-- Results -->
      <section class="lg:col-span-7">
        <div class="bg-white/80 backdrop-blur rounded-2xl shadow-lg border border-slate-200 p-6">
          <div class="flex items-center justify-between gap-4 flex-wrap">
            <div>
              <h2 class="text-lg font-bold text-slate-900">Mensagens prontas</h2>
              <p class="text-sm text-slate-600 mt-1">
                Gere e envie. Se quiser, você pode editar antes de mandar.
              </p>
            </div>

            {% if messages is defined and messages and (messages|length) > 0 %}
            <div class="text-xs text-slate-500">
              Total: <b class="text-slate-900">{{ messages|length }}</b>
            </div>
            {% endif %}
          </div>

          {% if messages is not defined or not messages or (messages|length) == 0 %}
            <div class="mt-6 rounded-2xl border border-dashed border-slate-300 bg-slate-50 p-6">
              <p class="text-slate-700 font-semibold">Nenhuma mensagem ainda.</p>
              <p class="text-sm text-slate-600 mt-1">
                Preencha os campos ao lado e clique em <b>Gerar mensagens</b>.
              </p>
            </div>
          {% else %}
            <div class="mt-6 space-y-4">
              {% for item in messages %}
              <article class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
                <div class="flex items-start justify-between gap-3">
                  <div class="text-xs font-bold text-slate-500">
                    Mensagem {{ loop.index }}
                  </div>

                  <div class="flex gap-2">
                    <a
                      href="{{ item.wa_link }}"
                      target="_blank"
                      rel="noopener"
                      class="inline-flex items-center justify-center rounded-xl bg-brand-600 px-3 py-2 text-sm font-bold text-white hover:bg-brand-700 transition"
                      title="Abrir WhatsApp com a mensagem pronta"
                    >
                      Enviar no WhatsApp
                    </a>

                    <button
                      type="button"
                      class="inline-flex items-center justify-center rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-bold text-slate-800 hover:bg-slate-50 transition"
                      onclick="copyMsg(this)"
                      data-text="{{ item.text | e }}"
                      title="Copiar a mensagem"
                    >
                      Copiar
                    </button>
                  </div>
                </div>

                <p class="mt-3 whitespace-pre-wrap text-slate-900 leading-relaxed">
                  {{ item.text }}
                </p>
              </article>
              {% endfor %}
            </div>
          {% endif %}
        </div>

        <!-- Toast -->
        <div id="toast"
             class="fixed bottom-5 left-1/2 -translate-x-1/2 hidden rounded-xl bg-slate-900 text-white px-4 py-3 text-sm shadow-lg">
          Copiado!
        </div>
      </section>
    </div>
  </div>
</main>

<script>
  function copyMsg(btn) {
    const text = btn.getAttribute("data-text") || "";
    if (!text) return;

    navigator.clipboard.writeText(text).then(() => {
      const toast = document.getElementById("toast");
      toast.classList.remove("hidden");
      setTimeout(() => toast.classList.add("hidden"), 1400);
    }).catch(() => {
      // fallback simples
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);

      const toast = document.getElementById("toast");
      toast.classList.remove("hidden");
      setTimeout(() => toast.classList.add("hidden"), 1400);
    });
  }
</script>
{% endblock %}