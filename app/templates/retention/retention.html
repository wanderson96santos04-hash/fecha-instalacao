{% extends "base.html" %}

{% block body %}
  {# tenta puxar a navbar do painel se existir #}
  {% include "partials/nav_app.html" ignore missing %}

  <main class="flex-1">
    <div class="max-w-6xl mx-auto px-4 py-10">

      <header class="mb-8">
        <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight text-slate-900">
          Módulo de Retenção
        </h1>
        <p class="mt-2 text-slate-600 text-lg">
          Relatório semanal automático com seus números.
        </p>
      </header>

      <section class="bg-white/80 backdrop-blur rounded-2xl shadow-lg border border-slate-200 p-6 md:p-7">
        <div class="flex items-start justify-between gap-4 flex-wrap">
          <div>
            <h2 class="text-xl font-extrabold text-slate-900">Relatório da semana</h2>
            <p class="mt-1 text-sm text-slate-500">
              {{ now.strftime("%d/%m/%Y %H:%M UTC") if now is defined else "" }}
            </p>
          </div>

          {% if report_text is defined and report_text %}
            <button
              id="copyReportBtn"
              type="button"
              class="inline-flex items-center gap-2 rounded-lg bg-slate-900 text-white px-4 py-2 text-sm font-semibold hover:bg-slate-800"
            >
              Copiar relatório
            </button>
          {% endif %}
        </div>

        <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="rounded-xl border border-slate-200 bg-white p-4">
            <div class="text-sm font-semibold text-slate-500">Orçamentos criados</div>
            <div class="mt-1 text-3xl font-extrabold text-slate-900">
              {{ created_count|default(0) }}
            </div>
          </div>

          <div class="rounded-xl border border-slate-200 bg-white p-4">
            <div class="text-sm font-semibold text-slate-500">Fechados</div>
            <div class="mt-1 text-3xl font-extrabold text-slate-900">
              {{ closed_count|default(0) }}
            </div>
          </div>

          <div class="rounded-xl border border-slate-200 bg-white p-4">
            <div class="text-sm font-semibold text-slate-500">Taxa de conversão</div>
            <div class="mt-1 text-3xl font-extrabold text-slate-900">
              {{ conversion_rate|default(0) }}%
            </div>
          </div>
        </div>

        <div class="mt-6">
          <div class="text-sm font-semibold text-slate-700 mb-2">Relatório em texto</div>

          {% if report_text is defined and report_text %}
            <pre
              id="reportText"
              class="rounded-xl border border-slate-200 bg-white p-4 text-slate-900 whitespace-pre-wrap leading-relaxed"
            >{{ report_text }}</pre>

            <div class="mt-3">
              <span id="toast" class="hidden text-sm font-semibold text-green-600">Copiado ✔</span>
            </div>
          {% else %}
            <div class="rounded-xl border border-slate-200 bg-white p-4 text-slate-600">
              Nenhum dado suficiente para gerar o relatório ainda.
            </div>
          {% endif %}
        </div>
      </section>

    </div>
  </main>

  <script>
    (function () {
      const btn = document.getElementById("copyReportBtn");
      const toast = document.getElementById("toast");
      const pre = document.getElementById("reportText");

      const showToast = () => {
        if (!toast) return;
        toast.classList.remove("hidden");
        clearTimeout(window.__toastTimer);
        window.__toastTimer = setTimeout(() => toast.classList.add("hidden"), 1200);
      };

      const safeCopy = async (text) => {
        try {
          await navigator.clipboard.writeText(text);
          showToast();
        } catch (e) {
          const ta = document.createElement("textarea");
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
          showToast();
        }
      };

      if (btn && pre) {
        btn.addEventListener("click", () => safeCopy(pre.innerText || ""));
      }
    })();
  </script>
{% endblock %}