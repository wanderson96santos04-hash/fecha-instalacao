{% extends "base.html" %}

{% block body %}
{% set has_result = (result is defined and result) %}
{% set r = result|default('') %}

{% include "partials/nav_app.html" %}

<main class="flex-1">
  <div class="max-w-6xl mx-auto px-4 py-10">

    <header class="mb-10">
      <h1 class="text-4xl md:text-5xl font-extrabold tracking-tight text-slate-900">
        M√≥dulo de Prova Social
      </h1>
      <p class="mt-2 text-slate-600 text-lg">
        Gere depoimentos prontos para postar ‚Äî e exporte em PDF/PPT (PRO).
      </p>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">

      <!-- FORM -->
      <section class="bg-white/80 backdrop-blur rounded-2xl shadow-lg border border-slate-200 p-6 md:p-7">
        <form method="post" action="/app/social-proof/generate" class="space-y-5">
          <div>
            <label class="block text-sm font-semibold text-slate-800 mb-2">Servi√ßo fechado</label>
            <input
              name="servico"
              value="{{ form.servico|default('') if form is defined else '' }}"
              class="w-full rounded-xl border border-slate-200 bg-white px-4 py-3 text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-brand-600/30 focus:border-brand-600"
              placeholder="Ex: Instala√ß√£o el√©trica, Energia solar, Cerca el√©trica..."
              required
            />
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold text-slate-800 mb-2">Valor fechado</label>
              <input
                name="valor"
                value="{{ form.valor|default('') if form is defined else '' }}"
                class="w-full rounded-xl border border-slate-200 bg-white px-4 py-3 text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-brand-600/30 focus:border-brand-600"
                placeholder="Ex: 3500 ou 3.500,00"
                required
              />
            </div>

            <div>
              <label class="block text-sm font-semibold text-slate-800 mb-2">Cidade</label>
              <input
                name="cidade"
                value="{{ form.cidade|default('') if form is defined else '' }}"
                class="w-full rounded-xl border border-slate-200 bg-white px-4 py-3 text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-brand-600/30 focus:border-brand-600"
                placeholder="Ex: Belo Horizonte"
                required
              />
            </div>
          </div>

          <div>
            <label class="block text-sm font-semibold text-slate-800 mb-2">Detalhe (opcional)</label>
            <input
              name="detalhe"
              value="{{ form.detalhe|default('') if form is defined else '' }}"
              class="w-full rounded-xl border border-slate-200 bg-white px-4 py-3 text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-brand-600/30 focus:border-brand-600"
              placeholder="Ex: Cliente elogiou a rapidez e acabamento"
            />
          </div>

          <button
            type="submit"
            class="w-full rounded-xl bg-brand-600 hover:bg-brand-700 text-white font-semibold py-3.5 shadow-md shadow-brand-600/20 transition"
          >
            Gerar prova social
          </button>

          <p class="text-xs text-slate-500 flex items-center gap-2">
            ‚úÖ Texto liberado pra todos. <b>PDF/PPT √© PRO.</b>
          </p>
        </form>
      </section>

      <!-- RESULT -->
      <section class="bg-white/80 backdrop-blur rounded-2xl shadow-lg border border-slate-200 p-6 md:p-7">
        <div class="flex items-start justify-between gap-4">
          <div>
            <h2 class="text-xl font-extrabold text-slate-900">Resultado</h2>
            <p class="mt-1 text-sm text-slate-500">
              Gere o texto e copie para postar. Exporta√ß√£o em PDF/PPT √© para PRO.
            </p>
          </div>

          <div class="text-sm text-slate-500">
            {{ now.strftime("%d/%m/%Y %H:%M UTC") if now is defined else "" }}
          </div>
        </div>

        <div class="mt-4">
          {% if has_result %}
            <div class="rounded-xl border border-slate-200 bg-white p-4">
              <div class="flex items-center justify-between gap-3 mb-3">
                <div class="text-sm font-semibold text-slate-500">Texto gerado</div>
                <button
                  type="button"
                  id="copyBtn"
                  class="inline-flex items-center gap-2 rounded-lg bg-slate-900 text-white px-3 py-1.5 text-sm font-semibold hover:bg-slate-800"
                  data-copy="{{ r|replace('\r\n','\n')|replace('\r','\n') }}"
                >
                  Copiar
                </button>
              </div>

              <div class="text-slate-900 leading-relaxed whitespace-pre-line" id="resultText">
                {{ r }}
              </div>
            </div>
          {% else %}
            <div class="rounded-xl border border-slate-200 bg-white p-4 text-slate-600">
              Preencha o formul√°rio e clique em <b>Gerar prova social</b>.
            </div>
          {% endif %}
        </div>

        <!-- ‚úÖ (1) S√≥ mostrar bot√µes PRO depois que existir resultado -->
        {% if has_result %}
          <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
            <!-- PDF -->
            {% if user and user.is_pro %}
              <form method="post" action="/app/social-proof/pdf">
                <input type="hidden" name="text" value="{{ r }}">
                <button
                  type="submit"
                  class="w-full inline-flex items-center justify-center gap-2 rounded-xl border border-slate-200 bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800"
                >
                  üìÑ Exportar PDF
                </button>
              </form>
            {% else %}
              <a
                href="/app/upgrade"
                class="w-full inline-flex items-center justify-center gap-2 rounded-xl border border-yellow-200 bg-yellow-50 px-4 py-2 text-sm font-semibold text-yellow-700 hover:bg-yellow-100"
                title="Dispon√≠vel apenas no Plano PRO"
              >
                üîí Exportar PDF (PRO)
              </a>
            {% endif %}

            <!-- PPT -->
            {% if user and user.is_pro %}
              <form method="post" action="/app/social-proof/ppt">
                <input type="hidden" name="text" value="{{ r }}">
                <button
                  type="submit"
                  class="w-full inline-flex items-center justify-center gap-2 rounded-xl border border-slate-200 bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800"
                >
                  üñ•Ô∏è Exportar PPT
                </button>
              </form>
            {% else %}
              <a
                href="/app/upgrade"
                class="w-full inline-flex items-center justify-center gap-2 rounded-xl border border-yellow-200 bg-yellow-50 px-4 py-2 text-sm font-semibold text-yellow-700 hover:bg-yellow-100"
                title="Dispon√≠vel apenas no Plano PRO"
              >
                üîí Exportar PPT (PRO)
              </a>
            {% endif %}
          </div>

          <!-- ‚úÖ (2) Texto de convers√£o melhorado -->
          {% if not user or not user.is_pro %}
            <p class="mt-3 text-xs text-slate-500">
              üöÄ Instale mais autoridade nas redes. Exporte em PDF/PPT com o Plano Premium.
            </p>
          {% endif %}
        {% endif %}

        <div class="mt-3">
          <span id="toast" class="hidden text-sm font-semibold text-green-600">Copiado ‚úî</span>
        </div>

      </section>
    </div>
  </div>
</main>

<script>
  (function () {
    const toast = document.getElementById("toast");
    const showToast = () => {
      if (!toast) return;
      toast.classList.remove("hidden");
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(() => toast.classList.add("hidden"), 1200);
    };

    const safeCopy = async (text) => {
      try {
        await navigator.clipboard.writeText(text);
        showToast();
      } catch (e) {
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        showToast();
      }
    };

    const copyBtn = document.getElementById("copyBtn");
    if (copyBtn) {
      copyBtn.addEventListener("click", () => {
        const txt = copyBtn.getAttribute("data-copy") || "";
        safeCopy(txt);
      });
    }
  })();
</script>
{% endblock %}