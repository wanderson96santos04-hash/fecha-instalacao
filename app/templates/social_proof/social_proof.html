{% extends "base_app.html" %}

{% block body %}
{% set f = form|default({'servico':'','valor':'','cidade':'','detalhe':''}) %}

<main class="flex-1">
  {% include "partials/nav_app.html" %}

  <div class="max-w-6xl mx-auto px-4 py-10">
    <header class="mb-10">
      <h1 class="text-4xl font-extrabold tracking-tight text-slate-900">MÃ³dulo de Prova Social</h1>
      <p class="mt-2 text-slate-600 text-lg">
        Gere depoimentos prontos para postar â€” e exporte em PDF/PPT (PRO).
      </p>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">

      <!-- FORM -->
      <section class="bg-white/80 backdrop-blur rounded-2xl shadow-lg border border-slate-200 p-6 md:p-7">
        <form method="post" action="/app/social-proof/generate" class="space-y-4">

          <div>
            <label class="block text-sm font-semibold text-slate-800 mb-2">ServiÃ§o fechado</label>
            <input name="servico" value="{{ f.servico|default('') }}"
              class="w-full rounded-xl border border-slate-200 bg-white px-4 py-3 text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-brand-600/30 focus:border-brand-600"
              placeholder="Ex: InstalaÃ§Ã£o elÃ©trica, Energia solar, Cerca elÃ©trica..." required />
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-semibold text-slate-800 mb-2">Valor fechado</label>
              <input name="valor" value="{{ f.valor|default('') }}"
                class="w-full rounded-xl border border-slate-200 bg-white px-4 py-3 text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-brand-600/30 focus:border-brand-600"
                placeholder="Ex: 3500 ou 3.500,00" />
            </div>

            <div>
              <label class="block text-sm font-semibold text-slate-800 mb-2">Cidade</label>
              <input name="cidade" value="{{ f.cidade|default('') }}"
                class="w-full rounded-xl border border-slate-200 bg-white px-4 py-3 text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-brand-600/30 focus:border-brand-600"
                placeholder="Ex: Belo Horizonte" />
            </div>
          </div>

          <div>
            <label class="block text-sm font-semibold text-slate-800 mb-2">Detalhe (opcional)</label>
            <input name="detalhe" value="{{ f.detalhe|default('') }}"
              class="w-full rounded-xl border border-slate-200 bg-white px-4 py-3 text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-brand-600/30 focus:border-brand-600"
              placeholder="Ex: Cliente elogiou a rapidez e acabamento" />
          </div>

          <button type="submit"
            class="w-full rounded-xl bg-brand-600 hover:bg-brand-700 text-white font-semibold py-3.5 shadow-md shadow-brand-600/20 transition">
            Gerar prova social
          </button>
        </form>
      </section>

      <!-- RESULT -->
      <section class="bg-white/80 backdrop-blur rounded-2xl shadow-lg border border-slate-200 p-6 md:p-7">
        <div class="flex items-center justify-between gap-4">
          <h2 class="text-xl font-extrabold text-slate-900">Resultado</h2>
          <div class="text-sm text-slate-500">
            {{ now.strftime("%d/%m/%Y %H:%M UTC") if now is defined else "" }}
          </div>
        </div>

        {% if result_text %}
          <div class="mt-4 flex flex-wrap items-center gap-2">
            <button id="copyBtn" type="button"
              class="inline-flex items-center gap-2 rounded-lg bg-slate-900 text-white px-3 py-2 text-sm font-semibold hover:bg-slate-800">
              Copiar texto
            </button>

            {% if user and user.is_pro %}
              <form method="post" action="/app/social-proof/pdf">
                <input type="hidden" name="text" value="{{ result_text|e }}" />
                <button type="submit"
                  class="inline-flex items-center gap-2 rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-900 hover:bg-slate-50">
                  Exportar PDF
                </button>
              </form>

              <form method="post" action="/app/social-proof/ppt">
                <input type="hidden" name="text" value="{{ result_text|e }}" />
                <button type="submit"
                  class="inline-flex items-center gap-2 rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-900 hover:bg-slate-50">
                  Exportar PPT
                </button>
              </form>
            {% else %}
              <a href="/app/upgrade"
                class="inline-flex items-center gap-2 rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-500 hover:bg-slate-50"
                title="ExportaÃ§Ã£o disponÃ­vel apenas no Plano Pro">
                ðŸ”’ Exportar PDF
              </a>
              <a href="/app/upgrade"
                class="inline-flex items-center gap-2 rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-500 hover:bg-slate-50"
                title="ExportaÃ§Ã£o disponÃ­vel apenas no Plano Pro">
                ðŸ”’ Exportar PPT
              </a>
            {% endif %}

            <span id="toast" class="hidden text-sm font-semibold text-green-600">Copiado âœ”</span>
          </div>

          <div class="mt-5 rounded-xl border border-slate-200 bg-white p-4">
            <pre id="resultText" class="whitespace-pre-wrap text-slate-900 leading-relaxed">{{ result_text }}</pre>
          </div>
        {% else %}
          <p class="mt-4 text-slate-600">
            Preencha o formulÃ¡rio e clique em <b>Gerar prova social</b>.
          </p>
        {% endif %}
      </section>

    </div>
  </div>
</main>

<script>
  (function () {
    const toast = document.getElementById("toast");
    const result = document.getElementById("resultText");
    const btn = document.getElementById("copyBtn");

    const showToast = () => {
      if (!toast) return;
      toast.classList.remove("hidden");
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(() => toast.classList.add("hidden"), 1200);
    };

    const safeCopy = async (text) => {
      try {
        await navigator.clipboard.writeText(text);
        showToast();
      } catch (e) {
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        showToast();
      }
    };

    if (btn && result) {
      btn.addEventListener("click", () => safeCopy(result.innerText || ""));
    }
  })();
</script>
{% endblock %}