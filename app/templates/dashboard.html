{% extends "base.html" %}
{% block body %}
  {% include "partials/nav_app.html" %}
  {% include "partials/flash.html" %}

  <main class="mx-auto max-w-5xl px-4 py-6">
    <div class="flex flex-col gap-4 sm:flex-row sm:items-end sm:justify-between">
      <div>
        <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight">OrÃ§amentos em andamento</h1>

        {% if user.is_pro %}
          <p class="mt-1 text-sm text-slate-600">
            Plano: <span class="font-bold text-slate-900">Premium</span> â€¢ ilimitado âœ…
          </p>
        {% else %}
          <p class="mt-1 text-sm text-slate-600">
            Plano: <span class="font-bold text-slate-900">Free</span> â€¢ restante: <span class="font-bold">{{ remaining }}</span>/10
            â€¢ <a href="/app/upgrade" class="font-bold text-slate-900 hover:underline">virar Premium</a>
          </p>
        {% endif %}
      </div>

      <a href="/app/budgets/new"
         class="w-full sm:w-auto text-center rounded-2xl px-6 py-4 font-extrabold text-white bg-slate-900 hover:bg-slate-800 shadow-sm">
        + Novo OrÃ§amento
      </a>
    </div>

    <!-- ======= VISÃƒO ESTRATÃ‰GICA (subir nÃ­vel) ======= -->
    <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5">
        <p class="text-xs font-bold text-slate-500">FECHADO (MÃŠS)</p>
        <p class="mt-2 text-2xl font-extrabold tracking-tight text-slate-900">{{ metrics.month_won_value }}</p>
        <p class="mt-1 text-sm text-slate-600">{{ metrics.month_won_count }} fechados</p>
      </div>

      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5">
        <p class="text-xs font-bold text-slate-500">PERDIDO (MÃŠS)</p>
        <p class="mt-2 text-2xl font-extrabold tracking-tight text-slate-900">{{ metrics.month_lost_value }}</p>
        <p class="mt-1 text-sm text-slate-600">{{ metrics.month_lost_count }} perdidos</p>
      </div>

      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5">
        <p class="text-xs font-bold text-slate-500">CONVERSÃƒO (MÃŠS)</p>
        <p class="mt-2 text-2xl font-extrabold tracking-tight text-slate-900">{{ metrics.month_conversion_pct }}</p>
        <p class="mt-1 text-sm text-slate-600">{{ metrics.month_total_count }} orÃ§amentos no mÃªs</p>
      </div>

      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5">
        <p class="text-xs font-bold text-slate-500">AGUARDANDO (MÃŠS)</p>
        <p class="mt-2 text-2xl font-extrabold tracking-tight text-slate-900">{{ metrics.month_awaiting_count }}</p>
        <p class="mt-1 text-sm text-slate-600">
          {% set n = metrics.month_awaiting_count %}
          {{ n }} {% if n == 1 %}pendente{% else %}pendentes{% endif %} de resposta
        </p>
      </div>
    </div>

    <div class="mt-6 grid grid-cols-1 gap-4">
      {% if budgets|length == 0 %}
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
          <p class="text-base font-bold">Nenhum orÃ§amento ainda.</p>
          <p class="mt-1 text-sm text-slate-600">Clique em â€œ+ Novo OrÃ§amentoâ€ e envie no WhatsApp.</p>
        </div>
      {% endif %}

      {% for b in budgets %}
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5">
          <div class="flex items-start justify-between gap-3">
            <div>
              <p class="text-lg font-extrabold tracking-tight">{{ b.client_name }}</p>
              <p class="text-sm text-slate-600 mt-1">
                {{ b.service_type }} â€¢ {{ b.value }} â€¢ {{ b.payment_method }}
              </p>
              <p class="text-xs text-slate-500 mt-2">
                Telefone: <span class="font-semibold text-slate-700">{{ b.phone }}</span>
              </p>
              {% if b.notes %}
                <p class="mt-3 text-sm text-slate-700 whitespace-pre-line">{{ b.notes }}</p>
              {% endif %}
            </div>

            <div class="shrink-0">
              {% if b.status == "awaiting" %}
                <span class="inline-flex items-center gap-2 rounded-full bg-amber-50 text-amber-700 border border-amber-200 px-3 py-1 text-xs font-bold">
                  ğŸŸ¡ Aguardando
                </span>
              {% elif b.status == "won" %}
                <span class="inline-flex items-center gap-2 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-200 px-3 py-1 text-xs font-bold">
                  ğŸŸ¢ Fechado
                </span>
              {% else %}
                <span class="inline-flex items-center gap-2 rounded-full bg-rose-50 text-rose-700 border border-rose-200 px-3 py-1 text-xs font-bold">
                  ğŸ”´ Perdido
                </span>
              {% endif %}
            </div>
          </div>

          <div class="mt-4 flex flex-col sm:flex-row gap-3">
            <a href="/app/budgets/{{ b.id }}/whatsapp"
               class="w-full sm:w-auto text-center rounded-2xl px-6 py-4 font-extrabold text-white bg-slate-900 hover:bg-slate-800 shadow-sm">
              ğŸ”¥ Enviar no WhatsApp
            </a>

            {% if can_followup(b.created_at) %}
              <a href="/app/budgets/{{ b.id }}/followup"
                 class="w-full sm:w-auto text-center rounded-2xl px-6 py-4 font-extrabold bg-white border border-slate-200 hover:bg-slate-100 shadow-sm">
                ğŸ”¥ Lembrar cliente
              </a>
            {% else %}
              <button disabled
                 class="w-full sm:w-auto text-center rounded-2xl px-6 py-4 font-extrabold bg-slate-100 border border-slate-200 text-slate-400 cursor-not-allowed">
                ğŸ”¥ Lembrar cliente (24h)
              </button>
            {% endif %}
          </div>

          <div class="mt-4 flex flex-col sm:flex-row gap-2">
            <form method="post" action="/app/budgets/{{ b.id }}/status" class="w-full sm:w-auto">
              <input type="hidden" name="status" value="awaiting" />
              <button class="w-full rounded-2xl px-4 py-3 text-sm font-extrabold bg-white border border-slate-200 hover:bg-slate-100">
                ğŸŸ¡ Aguardando
              </button>
            </form>
            <form method="post" action="/app/budgets/{{ b.id }}/status" class="w-full sm:w-auto">
              <input type="hidden" name="status" value="won" />
              <button class="w-full rounded-2xl px-4 py-3 text-sm font-extrabold bg-white border border-slate-200 hover:bg-slate-100">
                ğŸŸ¢ Fechado
              </button>
            </form>
            <form method="post" action="/app/budgets/{{ b.id }}/status" class="w-full sm:w-auto">
              <input type="hidden" name="status" value="lost" />
              <button class="w-full rounded-2xl px-4 py-3 text-sm font-extrabold bg-white border border-slate-200 hover:bg-slate-100">
                ğŸ”´ Perdido
              </button>
            </form>
          </div>
        </div>
      {% endfor %}
    </div>

    {% if not user.is_pro %}
      <div class="mt-6 bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
        <p class="text-base font-extrabold">Premium: ilimitado por R$ 39,90/mÃªs</p>
        <p class="mt-2 text-sm text-slate-600">
          Pagamento via Kiwify. Assim que confirmar, seu Premium ativa automaticamente. âœ…
        </p>
        <div class="mt-4">
          <a href="/app/upgrade"
             class="inline-flex items-center justify-center rounded-2xl px-6 py-4 font-extrabold text-white bg-slate-900 hover:bg-slate-800 shadow-sm">
            Ver Premium
          </a>
        </div>
      </div>
    {% endif %}
  </main>
{% endblock %}